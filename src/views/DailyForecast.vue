<template>
    <div class="container-fluid">
        <h1 class="text-center text-light">Next 48 Hours Forecast</h1>
        <div class="row">
            <!-- Date and forecasts is defined on each day. -->
            <div class="col" v-for="day in divideForecasts()" :key="day.date">
                <h3 class="text-center text-light">{{day.date}}</h3>
                <table class="table table-striped-columns">
                    <thead>
                        <tr>
                            <th scope="col" class="text-center">Time</th>
                            <th scope="col" class="text-center">Temperature</th>
                            <th scope="col" class="text-center">Rain</th>
                            <th scope="col" class="text-center">Wind</th>
                            <th scope="col" class="text-center">Short Forecast</th>
                        </tr>
                    </thead>
                    <tbody class="table-group-divider">
                        <tr v-for="forecast in day.forecasts" :key="forecast.number">
                            <th scope="row" class="text-center"><b>{{ formatTime(forecast.start_time) }}</b></th>
                            <td class="text-center">{{ forecast.temperature }}&#176;F</td>
                            <td class="text-center">{{ forecast.chance_of_rain }}%</td>
                            <td class="text-center">{{ forecast.wind_speed }} {{ forecast.wind_direction }}</td>
                            <td class="text-center">{{ forecast.short_forecast }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

<script setup lang="ts">
import { useWeatherStore } from '../store/weather';
import hourlyForecast from '../models/hourlyForecast';

const weatherStore = useWeatherStore();


const divideForecasts = () => {
    const days: Object[] = [];
    let forecasts: hourlyForecast[] = [];
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    let currentDay = new Date((typeof weatherStore.hourlyForecast[0].start_time === "string" ? new Date(weatherStore.hourlyForecast[0].start_time) : weatherStore.hourlyForecast[0].start_time).toLocaleString("en-US", { timeZone: tz }));
    const startDay = currentDay.getDate();
    for (const forecast of weatherStore.hourlyForecast) {
        const day = new Date((typeof forecast.start_time === "string" ? new Date(forecast.start_time) : forecast.start_time).toLocaleString("en-US", { timeZone: tz }));
        // break if we're more than 2 days out.
        if (day.getDate() > startDay+2) break;
        if (day.getDate() === currentDay.getDate()) {
            forecasts.push(forecast);
            // console.log(currentDay.getDate(), day.getDate());
        } else {
            let dateValue = "";
            // decide what value to put for date
            if (days.length === 0) dateValue = "Today";
            else if (days.length === 1) dateValue = "Tomorrow";
            // push the date and the forecasts
            days.push({
                "date": dateValue,
                "forecasts": forecasts
            })
            // clear the array
            forecasts = [];
            // set currentDay to the new day and push this forecast to forecasts
            currentDay = day;
            forecasts.push(forecast);
        }
    }
    days.push({
        "date": currentDay.toDateString().substring(0, 10),
        "forecasts": forecasts
    })
    return days;
}



const formatTime = (fDate: any) => {
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const tzDate = new Date((typeof fDate === "string" ? new Date(fDate) : fDate).toLocaleString("en-US", { timeZone: tz }))
    if (tzDate.getHours() >= 12) {
        return tzDate.getHours() > 12 ? `${tzDate.getHours() - 12}:00 pm` : `12:00 pm`;
    } else if (tzDate.getHours() < 12 && tzDate.getHours() > 0) {
        return `${tzDate.getHours()}:00 am`;
    } else {
        return '12:00 am'
    }
}
</script>